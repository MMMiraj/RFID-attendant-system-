#include <SPI.h>
#include <MFRC522.h>
#include <Arduino.h>
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClientSecureBearSSL.h>
#include <LiquidCrystal_I2C.h>
#include <Wire.h>

//------------------ ESP8266 Pin Definitions ------------------
#define RST_PIN 0    // D3 (GPIO0)
#define SS_PIN 2     // D4 (GPIO2)
#define BUZZER 15    // D8 (GPIO15)

// MFRC522 Library Initialization
MFRC522 mfrc522(SS_PIN, RST_PIN);
MFRC522::MIFARE_Key key;

//------------------ RFID & Google Sheet ------------------
const int blockNum = 2; // Data is expected to be stored in Block 2
const byte bufferLen = 16; // Maximum data bytes in a MIFARE Classic data block
byte readBlockData[bufferLen];

// The URL for your Google Apps Script Web App (append ?name=CardData)
const char* sheet_url = "https://script.google.com/macros/s/AKfycbzD8Wy7mw6jAhiQiQYIRzoGUZCNjvZz7Z-VNFYGbNdLVgblj459wRV_4Ok6namd67Xp/exec?name=";

//------------------ WiFi ------------------
const char* WIFI_SSID = "XXXXXXX";
const char* WIFI_PASSWORD = "XXXXXXXX";

//------------------ LCD ------------------
// I2C Address 0x3F or 0x27, 16 columns, 2 rows
LiquidCrystal_I2C lcd(0x27, 16, 2); 

//------------------ Setup ------------------
void setup() {
  Serial.begin(115200);

  // LCD Setup
  lcd.init();
  lcd.backlight();
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("Initializing...");

  // Buzzer Setup
  pinMode(BUZZER, OUTPUT);
  digitalWrite(BUZZER, LOW);

  // I2C for LCD (D2=SDA=GPIO4, D1=SCL=GPIO5 on NodeMCU/ESP-01S)
  Wire.begin(4,5); 

  // SPI for RFID
  SPI.begin();
  mfrc522.PCD_Init();

  // WiFi Connection
  Serial.println("\nConnecting to WiFi...");
  lcd.setCursor(0,1);
  lcd.print("Connecting WiFi");
  
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  unsigned long start = millis();
  
  // Wait up to 15 seconds for connection
  while(WiFi.status() != WL_CONNECTED && millis()-start < 15000){
    Serial.print(".");
    delay(500);
  }
  
  if(WiFi.status() == WL_CONNECTED){
    Serial.println("\nWiFi connected. IP: " + WiFi.localIP().toString());
    lcd.setCursor(0,1);
    lcd.print("WiFi Connected!  ");
  } else {
    Serial.println("\nFailed to connect WiFi");
    lcd.setCursor(0,1);
    lcd.print("WiFi Failed!    ");
  }
  delay(1000); // Wait for the status message to be visible
}

//------------------ Read RFID Block ------------------
/**
 * @brief Authenticates and reads a block from the MIFARE card.
 * * @param blockNum The block number to read.
 * @param readBlockData The buffer to store the read data (must be >= 16 bytes).
 * @return true if read was successful, false otherwise.
 */
bool ReadDataFromBlock(int blockNum, byte readBlockData[]){
  // Prepare key (using default Key A: FFFFFFFFFFFFh)
  for(byte i=0;i<6;i++) key.keyByte[i]=0xFF;

  // Authenticate the block
  MFRC522::StatusCode status = mfrc522.PCD_Authenticate(MFRC522::PICC_CMD_MF_AUTH_KEY_A, blockNum, &key, &(mfrc522.uid));
  if(status != MFRC522::STATUS_OK){
    Serial.print("Authentication failed: "); 
    Serial.println(mfrc522.GetStatusCodeName(status));
    return false;
  }

  // Set 'len' to the maximum buffer size (18 is standard max for MIFARE block reading)
  // This resolves the "A buffer is not big enough." error.
  byte len = 18; 
  status = mfrc522.MIFARE_Read(blockNum, readBlockData, &len);
  
  if(status != MFRC522::STATUS_OK){
    Serial.print("Read failed: "); 
    Serial.println(mfrc522.GetStatusCodeName(status));
    return false;
  }

  return true;
}

//------------------ Loop ------------------
void loop(){
  lcd.setCursor(0,0);
  lcd.print("Scan your card   "); // Display ready message

  // Check for new card and read its UID
  if(mfrc522.PICC_IsNewCardPresent() && mfrc522.PICC_ReadCardSerial()){
    Serial.println("\nReading RFID...");

    // 1. Read the data block
    if(!ReadDataFromBlock(blockNum, readBlockData)){
      lcd.setCursor(0,1);
      lcd.print("Read Failed!    ");
      // Halt card and stop encryption
      mfrc522.PICC_HaltA();
      mfrc522.PCD_StopCrypto1();
      delay(1500);
      return;
    }

    // 2. Convert data to string
    String cardData = "";
    for(int i=0;i<bufferLen;i++){
      // Stop at null character (or just skip 0x00 for padding)
      if(readBlockData[i] != 0) {
          cardData += (char)readBlockData[i];
      } else {
          // If we hit a null character, we can stop reading further
          break; 
      }
    }
    cardData.trim();
    Serial.print("Card Data: "); 
    Serial.println(cardData);

    // 3. Display on LCD
    lcd.setCursor(0,1);
    lcd.print("                "); // Clear line
    lcd.setCursor(0,1);
    lcd.print("Hey "+cardData+"!");

    // 4. Buzzer feedback
    for(int i=0;i<2;i++){
      digitalWrite(BUZZER,HIGH);
      delay(150);
      digitalWrite(BUZZER,LOW);
      delay(150);
    }

    // 5. Halt card & stop encryption
    mfrc522.PICC_HaltA();
    mfrc522.PCD_StopCrypto1();

    // 6. Send to Google Sheet
    if(WiFi.status() == WL_CONNECTED){
      Serial.println("Sending data to Google Sheet...");
      BearSSL::WiFiClientSecure client;
      client.setInsecure(); // This is needed for many GScript URLs
      HTTPClient https;

      String url = String(sheet_url) + cardData;
      url.replace(" ", "%20"); // Encode spaces for URL
      
      if(https.begin(client, url)){
        int httpCode = https.GET();
        
        if(httpCode > 0){
          Serial.printf("HTTPS GET code: %d\n", httpCode);
          lcd.setCursor(0,1); 
          lcd.print("Data Recorded!  ");
        } else {
          Serial.printf("HTTPS GET failed: %s\n", https.errorToString(httpCode).c_str());
          lcd.setCursor(0,1); 
          lcd.print("Send Failed!    ");
        }
        https.end();
      } else {
        Serial.println("Unable to connect HTTPS");
        lcd.setCursor(0,1); 
        lcd.print("Conn HTTPS Fail ");
      }
    } else {
      Serial.println("WiFi not connected, skipping send");
      lcd.setCursor(0,1); 
      lcd.print("No WiFi Conn    ");
    }

    delay(2000); // Wait before scanning for the next card
  }
}
