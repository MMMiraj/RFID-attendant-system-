#include <SPI.h>
#include <MFRC522.h>
#include <Arduino.h>
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClientSecureBearSSL.h>
#include <LiquidCrystal_I2C.h>
#include <Wire.h>
#include <LittleFS.h>

// ---------------- ESP8266 Pin Definitions ----------------
#define RST_PIN 0    // D3
#define SS_PIN 2     // D4
#define BUZZER 15    // D8

MFRC522 mfrc522(SS_PIN, RST_PIN);
MFRC522::MIFARE_Key key;

// ---------------- RFID & Google Sheet ----------------
const int blockNum = 2;
const byte bufferLen = 16;
byte readBlockData[bufferLen];

const char* sheet_url = "Your Google Sheet URL";
//My Sheet URK (https://script.google.com/macros/s/AKfycbzD8Wy7mw6jAhiQiQYIRzoGUZCNjvZz7Z-VNFYGbNdLVgblj459wRV_4Ok6namd67Xp/exec?name=)

// ---------------- WiFi ----------------
const char* WIFI_SSID = "XXXXXX";
const char* WIFI_PASSWORD = "XXXXXXXXX";

// ---------------- LCD ----------------
LiquidCrystal_I2C lcd(0x27, 16, 2);

// ---------------- File ----------------
String fileName = "/ids.txt";

// ---------------- Timers ----------------
unsigned long wifiCheckTimer = 0;
const unsigned long wifiCheckInterval = 5000; // check WiFi every 5 sec

// ---------------- Save ID Offline ----------------
void saveID(String id) {
  File file = LittleFS.open(fileName, "a");
  if (!file) {
    Serial.println("File open failed!");
    return;
  }
  file.println(id);
  file.close();
  Serial.println("Saved offline: " + id);
}

// ---------------- Count saved IDs ----------------
int countSavedIDs() {
  if (!LittleFS.exists(fileName)) return 0;
  File file = LittleFS.open(fileName, "r");
  if (!file) return 0;

  int count = 0;
  while (file.available()) {
    String line = file.readStringUntil('\n');
    line.trim();
    if (line != "") count++;
  }
  file.close();
  return count;
}

// ---------------- Upload Offline IDs ----------------
void uploadSavedIDs() {
  if (!LittleFS.exists(fileName)) return;

  File file = LittleFS.open(fileName, "r");
  if (!file) return;

  BearSSL::WiFiClientSecure client;
  client.setInsecure();
  HTTPClient https;

  lcd.setCursor(0,1);
  lcd.print("Uploading...     ");

  while (file.available()) {
    String id = file.readStringUntil('\n');
    id.trim();
    if (id == "") continue;

    String url = String(sheet_url) + id;
    url.replace(" ", "%20");

    if (https.begin(client, url)) {
      int httpCode = https.GET();
      Serial.printf("Upload %s -> Code %d\n", id.c_str(), httpCode);
      https.end();
      delay(200);
    }
  }

  file.close();
  LittleFS.remove(fileName);
  Serial.println("Upload complete â€” cleared offline file.");
}

// ---------------- Read RFID Block ----------------
bool ReadDataFromBlock(int blockNum, byte readBlockData[]) {
  for (byte i = 0; i < 6; i++) key.keyByte[i] = 0xFF;

  MFRC522::StatusCode status = mfrc522.PCD_Authenticate(
      MFRC522::PICC_CMD_MF_AUTH_KEY_A, blockNum, &key, &(mfrc522.uid)
  );

  if (status != MFRC522::STATUS_OK) return false;

  byte len = 18;
  status = mfrc522.MIFARE_Read(blockNum, readBlockData, &len);

  return (status == MFRC522::STATUS_OK);
}

// ---------------- Setup ----------------
void setup() {
  Serial.begin(115200);

  // LCD
  lcd.init();
  lcd.backlight();
  lcd.setCursor(0,0);
  lcd.print("Initializing...");

  pinMode(BUZZER, OUTPUT);
  digitalWrite(BUZZER, LOW);

  Wire.begin(4,5);
  SPI.begin();
  mfrc522.PCD_Init();

  if (!LittleFS.begin()) {
    Serial.println("LittleFS mount failed");
    lcd.setCursor(0,1);
    lcd.print("FS mount failed");
  } else {
    Serial.println("LittleFS mounted");
  }

  // WiFi Setup
  WiFi.mode(WIFI_STA);
  WiFi.setAutoReconnect(true);
  WiFi.persistent(true);
  WiFi.setSleepMode(WIFI_NONE_SLEEP);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  lcd.setCursor(0,1);
  lcd.print("Connecting WiFi");

  unsigned long start = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - start < 15000) {
    delay(500);
  }

  if (WiFi.status() == WL_CONNECTED) {
    lcd.setCursor(0,1);
    lcd.print("WiFi Conn->Upload");
    uploadSavedIDs();
  }
}

// ---------------- Loop ----------------
void loop() {
  // ---------------- WiFi status check + auto reconnect ----------------
  if (millis() - wifiCheckTimer > wifiCheckInterval) {
  wifiCheckTimer = millis();

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi lost. Reconnecting...");
    lcd.setCursor(0,1);
    lcd.print("Offline Mode     ");
    
    WiFi.begin(WIFI_SSID, WIFI_PASSWORD); // Try connecting again
  } 
  else {
    lcd.setCursor(0,1);
    lcd.print("WiFi OK ->Upload ");
    uploadSavedIDs(); // Only upload when connected
  }
}

  // ---------------- Card Scanning ----------------
  if (mfrc522.PICC_IsNewCardPresent() && mfrc522.PICC_ReadCardSerial()) {

    // Try reading card block
    if (!ReadDataFromBlock(blockNum, readBlockData)) {
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("Read Failed!");
      Serial.println("RFID Read Failed!");
      delay(1200);

      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("Scan your card");
      return;
    }

    // Convert block bytes to string
    String cardData = "";
    for (int i = 0; i < bufferLen; i++) {
      if (readBlockData[i] != 0) cardData += (char)readBlockData[i];
      else break;
    }
    cardData.trim();

    Serial.println("Card Data: " + cardData);

    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("Hey ");
    lcd.print(cardData);

    // Buzzer feedback
    digitalWrite(BUZZER, HIGH); delay(120);
    digitalWrite(BUZZER, LOW);  delay(120);
    digitalWrite(BUZZER, HIGH); delay(120);
    digitalWrite(BUZZER, LOW);

    // Stop card communication
    mfrc522.PICC_HaltA();
    mfrc522.PCD_StopCrypto1();

    // Save ID locally
    saveID(cardData);

    // Show saved count
    int offlineCount = countSavedIDs();
    lcd.setCursor(0,1);
    lcd.print("Stored: ");
    lcd.print(offlineCount);
    Serial.println("Offline stored: " + String(offlineCount));
    delay(1500);

    // Try upload if WiFi connected
    if (WiFi.status() == WL_CONNECTED) {
      lcd.setCursor(0,1);
      lcd.print("Uploading...");
      uploadSavedIDs();
      delay(1000);
    }

    // Ready for next scan
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("Scan your card");
}
}

